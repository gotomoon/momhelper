---
import { Icon } from 'astro-icon/components';
import Logo from '~/components/Logo.astro';
import ToggleTheme from '~/components/common/ToggleTheme.astro';
import Button from '~/components/ui/Button.astro';

import { trimSlash } from '~/utils/permalinks';
import { getLocaleFromPath, getPathForRoute, getTranslatedPath, type Locale } from '~/utils/i18nRoutes';
import { getBlogTranslationMap } from '~/utils/blogTranslations';
import type { CallToAction } from '~/types';

interface Link {
  text?: string;
  href?: string;
  ariaLabel?: string;
  icon?: string;
  'data-lang-switch'?: string;
}

interface MenuLink extends Link {
  links?: Array<MenuLink>;
}

export interface Props {
  id?: string;
  links?: Array<MenuLink>;
  actions?: Array<CallToAction>;
  isSticky?: boolean;
  isDark?: boolean;
  isFullWidth?: boolean;
  showToggleTheme?: boolean;
  locale?: string;
  position?: string;
}

const {
  id = 'header',
  links = [],
  actions = [],
  isSticky = false,
  isDark = false,
  isFullWidth = false,
  showToggleTheme = false,
  locale: propLocale,
  position = 'center',
} = Astro.props;

const currentPath = `/${trimSlash(new URL(Astro.url).pathname)}`;

// Define supported locales
const locales: Array<{ code: Locale; label: string }> = [
  { code: 'en', label: 'English' },
  { code: 'ko', label: '한국어' },
];

// Define menu labels in each language
const menuTranslations: Record<string, Record<string, string>> = {
  en: {
    Home: 'Home',
    Services: 'Services',
    'Postpartum Care': 'Postpartum Care',
    Babysitter: 'Babysitter',
    Housekeeping: 'Housekeeping',
    'Elderly Care': 'Elderly Care',
    About: 'About',
    Reviews: 'Reviews',
    Blog: 'Blog',
    Contact: 'Contact',
    Language: 'Language',
  },
  ko: {
    Home: '홈',
    Services: '서비스',
    'Postpartum Care': '산후조리',
    Babysitter: '베이비시터',
    Housekeeping: '가사도우미',
    'Elderly Care': '노인돌봄',
    About: '소개',
    Reviews: '후기',
    Blog: '산후조리·육아정보',
    Contact: '연락처',
    Language: '언어',
  },
};

// Function to get the path for a route in a specific language
function getPath(route: string, locale: Locale): string {
  const resolvedPath = getPathForRoute(route, locale);
  if (!resolvedPath) {
    console.error(`Route mapping error for route: ${route} and locale: ${locale}`);
    return `/${locale}`;
  }
  return resolvedPath;
}

// Get current path information
const pathname = Astro.url.pathname || '/';
const blogTranslations = await getBlogTranslationMap();
const currentSlug = decodeURIComponent(trimSlash(pathname));
const currentBlogEntry = currentSlug ? blogTranslations[currentSlug] : undefined;
const detectedLocale = getLocaleFromPath(pathname);
const currentLocale = propLocale === 'en' || propLocale === 'ko' ? propLocale : detectedLocale;
const getSwitchHref = (targetLocale: Locale): string => {
  if (targetLocale === currentLocale) {
    return pathname;
  }

  if (currentBlogEntry) {
    const targetSlug = currentBlogEntry[targetLocale];
    if (targetSlug) {
      return `/${trimSlash(targetSlug)}`;
    }
    const blogFallback = getPathForRoute('blog', targetLocale);
    return blogFallback ?? `/${targetLocale}`;
  }

  return getTranslatedPath(pathname, targetLocale);
};

// Find the route for a given text
function findRouteForText(text: string): string | null {
  const textToRouteMapping: Record<string, string> = {
    // Top-level English mappings
    Home: 'home',
    About: 'about',
    Reviews: 'reviews',
    Blog: 'blog',
    Contact: 'contact',

    // Dropdown English mappings
    'About Postpartum Care': 'about-postpartum-care',
    'What is Postpartum Care?': 'what-is-postpartum-care',
    'Our Postpartum Care Service': 'postpartum-care',
    Pricing: 'pricing',
    'Book Online': 'book-online',
    'View All Services': 'other-services',
    'Q & A': 'faq',
    'Contact Us': 'contact',

    // Top-level Korean mappings
    홈: 'home',
    회사소개: 'about',
    소개: 'about',
    후기: 'reviews',
    이용후기: 'reviews',
    산후조리·육아정보: 'blog',
    연락처: 'contact',

    // Dropdown Korean mappings
    '산후조리에 관하여': 'about-postpartum-care',
    '산후조리사란?': 'what-is-postpartum-care',
    '산후조리 서비스 내용': 'postpartum-care',
    이용요금: 'pricing',
    '서비스 신청하기': 'book-online',
    '기타 서비스': 'other-services',
    '기타 서비스 신청하기': 'other-services-booking',
    'Q & A': 'faq',
  };

  return textToRouteMapping[text] || null;
}

// Translate menu text to current language
function translateMenuText(text: string): string {
  if (text === 'Language') {
    return menuTranslations[currentLocale]?.['Language'] || text;
  }
  return menuTranslations[currentLocale]?.[text] || text;
}

// Server-side language path translation
const translateLinks = (inputLinks: Array<MenuLink>) => {
  return inputLinks.map((link) => {
    const originalText = link.text || '';
    const translatedText = translateMenuText(originalText);

    if (link.links) {
      return {
        ...link,
        text: translatedText,
        links: translateLinks(link.links),
      };
    } else {
      const route = findRouteForText(originalText);
      let href = link.href;

      if (route) {
        href = getPath(route, currentLocale);
      } else if (link.href && !link.href.startsWith('http') && !link.href.startsWith('#')) {
        if (link.href.startsWith('/')) {
          const pathWithoutLeadingSlash = link.href.substring(1);
          if (pathWithoutLeadingSlash.startsWith(currentLocale)) {
            href = link.href;
          } else {
            href = `/${currentLocale}${link.href}`;
          }
        } else {
          href = `/${currentLocale}/${link.href}`;
        }
      }

      return {
        ...link,
        text: translatedText,
        href: href,
      };
    }
  });
};

// Apply server-side language path translation
const translatedLinks = translateLinks(links);
---

<header
  class:list={[
    { 'fixed w-full': isSticky, relative: !isSticky, dark: isDark },
    'top-0 z-40 flex-none mx-auto w-full border-b border-gray-50/0 transition-[opacity] ease-in-out',
  ]}
  {...isSticky ? { 'data-aw-sticky-header': true } : {}}
  {...id ? { id } : {}}
>
  <div class="hidden md:flex items-center justify-end gap-2 px-4 py-2 max-w-7xl mx-auto">
    {showToggleTheme && <ToggleTheme iconClass="w-6 h-6" />}
    <div class="flex gap-1">
      {
        locales.map((locale) => {
          const href = getSwitchHref(locale.code);
          const isActive = locale.code === currentLocale;
          return (
            <a
              href={href}
              class:list={[
                'px-2.5 py-1 rounded text-xs font-semibold transition-colors border',
                isActive
                  ? 'text-white border-white/70 bg-white/10'
                  : 'text-white/90 border-transparent hover:bg-white/10',
              ]}
              aria-label={locale.label}
              data-lang-switch={locale.code}
            >
              {locale.label}
            </a>
          );
        })
      }
    </div>
    {
      actions?.length ? (
        <span class="ml-2">
          {actions.map((btnProps) => (
            <Button
              {...btnProps}
              class="ml-2 py-2 px-4 text-xs font-semibold shadow-none w-auto border border-white/60 bg-white/10 text-white hover:bg-white/20"
            />
          ))}
        </span>
      ) : null
    }
  </div>

  <div
    class:list={[
      'relative text-gray-900 dark:text-slate-200 py-3 px-3 md:px-6 mx-auto w-full',
      {
        'md:flex md:justify-between': position !== 'center',
      },
      {
        'md:grid md:grid-cols-3 md:items-center': position === 'center',
      },
      {
        'max-w-7xl': !isFullWidth,
      },
    ]}
  >
    <div class:list={[{ 'mr-auto rtl:mr-0 rtl:ml-auto': position === 'right' }, 'flex justify-between']}>
      <a class="flex items-center" href={getPath('home', currentLocale)}>
        <Logo />
      </a>
      <div class="flex items-center gap-2 md:hidden">
        {showToggleTheme && <ToggleTheme iconClass="w-6 h-6" />}
        {/* Mobile Language Switcher */}
        <div class="flex gap-1">
          {
            locales.map((locale) => {
              const href = getSwitchHref(locale.code);
              const isActive = locale.code === currentLocale;
              return (
                <a
                  href={href}
                  class:list={[
                    'px-2 py-1 rounded text-xs font-semibold transition-colors',
                    isActive
                      ? 'text-gray-900 dark:text-white border border-gray-900 dark:border-gray-400 bg-gray-100 dark:bg-gray-700'
                      : 'text-gray-900 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700',
                  ]}
                  aria-label={locale.label}
                  data-lang-switch={locale.code}
                >
                  {locale.label}
                </a>
              );
            })
          }
        </div>
      </div>
    </div>
    <nav
      class="items-center w-full md:w-auto hidden md:flex md:mx-3 lg:mx-5 text-default overflow-y-auto overflow-x-hidden md:overflow-y-visible md:overflow-x-visible md:justify-self-center"
      aria-label="Main navigation"
    >
      <ul
        class="flex flex-col md:flex-row md:self-center w-full md:w-auto text-xl md:text-base lg:text-[1.05rem] tracking-[0.01rem] font-semibold md:justify-center md:gap-2 lg:gap-4"
      >
        {
          translatedLinks.map(({ text, href, links, ...rest }) => (
            <li class={links?.length ? 'dropdown' : ''}>
              {links?.length ? (
                <>
                  <button
                    type="button"
                    class="px-3 lg:px-4 py-3 flex items-center whitespace-nowrap transition-colors hover:text-[#b74000]"
                  >
                    {text}{' '}
                    <Icon name="tabler:chevron-down" class="w-4 h-4 ml-0.5 rtl:ml-0 rtl:mr-0.5 hidden md:inline" />
                  </button>
                  <ul class="dropdown-menu md:hidden md:backdrop-blur-md dark:md:bg-slate-900/80 rounded md:absolute pl-4 md:pl-0 font-semibold md:bg-white/90 md:min-w-[200px] drop-shadow-xl">
                    {links.map(({ text: text2, href: href2, ...rest2 }) => (
                      <li>
                        <a
                          class:list={[
                            'first:rounded-t last:rounded-b md:hover:bg-gray-100 dark:hover:bg-gray-700 py-2 px-5 block whitespace-nowrap text-gray-900 dark:text-white transition-colors hover:text-[#b74000]',
                            { 'aw-link-active': href2 === currentPath },
                          ]}
                          href={href2}
                          {...rest2}
                        >
                          {text2}
                        </a>
                      </li>
                    ))}
                  </ul>
                </>
              ) : (
                <a
                  class:list={[
                    'px-3 lg:px-4 py-3 flex items-center whitespace-nowrap transition-colors hover:text-[#b74000]',
                    { 'aw-link-active text-[#b74000]': href === currentPath },
                  ]}
                  href={href}
                  {...rest}
                >
                  {text}
                </a>
              )}
            </li>
          ))
        }
      </ul>
    </nav>
    {position === 'center' ? <div class="hidden md:block" aria-hidden="true" /> : null}
  </div>
</header>

<script>
  function attachEvent() {
    const dropdowns = document.querySelectorAll('.dropdown');

    dropdowns.forEach((dropdown) => {
      const button = dropdown.querySelector('button');
      const menu = dropdown.querySelector('.dropdown-menu');

      if (button && menu) {
        // Mobile: Toggle visibility on click
        button.addEventListener('click', (e) => {
          // Only handle click on mobile
          if (window.innerWidth < 768) {
            e.preventDefault();
            e.stopPropagation();

            // Close other dropdowns
            dropdowns.forEach((otherDropdown) => {
              if (otherDropdown !== dropdown) {
                const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                if (otherMenu) {
                  otherMenu.classList.add('hidden');
                }
              }
            });

            // Toggle current dropdown
            menu.classList.toggle('hidden');
          }
        });
      }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      // Only handle on mobile
      if (window.innerWidth < 768 && !e.target.closest('.dropdown')) {
        dropdowns.forEach((dropdown) => {
          const menu = dropdown.querySelector('.dropdown-menu');
          if (menu) {
            menu.classList.add('hidden');
          }
        });
      }
    });
  }

  // Attach on page load
  attachEvent();

  // Re-attach on page navigation (for SPA-like behavior)
  document.addEventListener('astro:after-swap', attachEvent);
</script>
