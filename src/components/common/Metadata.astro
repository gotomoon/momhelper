---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';
import { getLanguageAlternates, getLocaleFromPath, getOpenGraphLocale } from '~/utils/i18nRoutes';
import { getBlogTranslationMap } from '~/utils/blogTranslations';

import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
  structuredData,
} = Astro.props;

const pathname = Astro.url.pathname ?? '/';
const currentLocale = getLocaleFromPath(pathname);
const blogTranslations = await getBlogTranslationMap();
const languageAlternates = getLanguageAlternates(pathname, { canonical, blogTranslations });
const openGraphLocale = getOpenGraphLocale(currentLocale);
const normalizedStructuredData = Array.isArray(structuredData)
  ? structuredData
  : structuredData
    ? [structuredData]
    : [];

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: openGraphLocale,
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  }
);

seoProps.openGraph = { ...seoProps.openGraph, locale: openGraphLocale };
seoProps.languageAlternates = languageAlternates.length ? languageAlternates : undefined;

const adaptedOpenGraph = await adaptOpenGraphImages(seoProps?.openGraph, Astro.site);
const schemaLogo = adaptedOpenGraph?.images?.find((image) => image?.url)?.url;
const siteUrl = SITE?.site ?? (Astro.site ? String(Astro.site) : '');

const baseStructuredData = siteUrl
  ? [
      {
        '@context': 'https://schema.org',
        '@type': 'Organization',
        '@id': `${siteUrl}#organization`,
        name: SITE?.name,
        url: siteUrl,
        ...(schemaLogo ? { logo: schemaLogo } : {}),
        contactPoint: [
          {
            '@type': 'ContactPoint',
            contactType: 'customer service',
            telephone: '+1-213-808-4415',
            email: 'momhelperusa10@gmail.com',
            availableLanguage: ['en', 'ko'],
            areaServed: 'US',
          },
        ],
      },
      {
        '@context': 'https://schema.org',
        '@type': 'LocalBusiness',
        '@id': `${siteUrl}#localbusiness`,
        name: SITE?.name,
        url: siteUrl,
        ...(schemaLogo ? { image: schemaLogo } : {}),
        telephone: '+1-213-808-4415',
        email: 'momhelperusa10@gmail.com',
        areaServed: 'US',
        parentOrganization: {
          '@id': `${siteUrl}#organization`,
        },
      },
    ]
  : [];

const allStructuredData = [...baseStructuredData, ...normalizedStructuredData].filter(Boolean);
---

<AstroSeo {...{ ...seoProps, openGraph: adaptedOpenGraph }} />
{
  allStructuredData.map((schema) => (
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  ))
}
